#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>

#include "bt_encrypt.h"
#include "bt_usb.h"
#include "hid.h"


#define IF(comp) else if(c(d, comp, min(len, sizeof(comp))))
#define IFOR(cmp1, cmp2) else if(c(d, cmp1, min(len, sizeof(cmp1))) || c(d, cmp2, min(len, sizeof(cmp2))))
#define SEND(data) send_hid(data, sizeof(data))
#define RAND(data, len) do{int i;for(i=0;i<len;i++) (data)[i] = rand();}while(0)
#define DUMP(data, len) do{int i;for(i=0;i<len;i++) printf("%02X ", (uint8_t)data[i]); printf("\n"); }while(0)
static bool c(uint8_t *d1, uint8_t *d2, int l){
	int i;for(i=0;i<l;i++){ if(!(d1[i] == d2[i] || d2[i] == XXXX)) return false; } return true;
}

static uint8_t tk[16] = {0};
static uint8_t local_ltk[16] = HID_LOCAL_LTK;
static uint16_t conn_handle;
static uint8_t acl_count = 8;
static uint8_t ia[6], iat = 0xFF, ra[6] = {LOCAL_RAND_ADDR}, rat = 1;
static uint8_t smp_req[7], smp_rsp[7], irand[16], rrand[16];
static uint8_t encrypted = false;
static uint8_t is_reconnect = false;
static uint8_t report_data_offset = 0;
static uint8_t hid_enabled = 0;
static uint8_t send_buf[256][64], _fr, _ra;


static uint8_t RECV_LE_CONNECTED[] = {0x04,0x3e,0x13,0x01,0x00,};
static uint8_t RECV_LE_DISCONNECTED[] = {0x04,0x05,0x04,0x00,XXXX,XXXX,XXXX};
static uint8_t CMD_RESET[] = {0x01,0x03,0x0c,0x00};
static uint8_t CMD_DISCONNECT[] = {0x01,0x06,0x04,0x03,0x40,0x00,0x13};
static uint8_t CMP_CMP_RESET[] = {0x04, 0x0e, 0x04, 0x01, 0x03, 0x0c, 0x00};
static uint8_t LE_SET_ADV_PARAM[] = {0x01,0x06,0x20,0x0f,0x20,0x00,0x20,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00};
static uint8_t CMP_LE_SET_ADV_PARAM[] = {0x04,0x0e,0x04,0x01,0x06,0x20,0x00};
static uint8_t LE_SET_RAND_ADDR[] = {0x01,0x05,0x20,0x06, LOCAL_RAND_ADDR};
static uint8_t CMP_LE_SET_RAND_ADDR[] = {0x04,0x0e,0x04,0x01,0x05,0x20,0x00};
static uint8_t LE_SET_ADV_DATA[] = {0x01,0x08,0x20,0x0F,0x0E,0x03,0x19,0xc1,0x03,0x02,0x01,0x06,0x03,0x03,0x12,0x18,0x02,0x09,0x5f};
static uint8_t CMP_LE_SET_ADV_DATA[] = {0x04, 0x0e, 0x04, 0x01, 0x08, 0x20, 0x00};
static uint8_t LE_SET_ADV_ENABLE[] = {0x01,0x0a,0x20,0x01,0x01};
static uint8_t RECV_LE_CONNECTED_TOUT[] = {0x04,0x3e,0x13,0x01,0x3c,};
static uint8_t CMP_LE_SET_ADV_ENABLE[] = {0x04,0x0e,0x04,0x01,0x0a,0x20,0x00};
static uint8_t RECV_IOS_UNKNOWN_L2CAP[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x3a,0x00};
static uint8_t RSP_IOS_UNKNOWN_L2CAP[] = {0x02,0x40,0x00,0x0e,0x00,0x0a,0x00,0x05,0x00,0x01,0x00,0x06,0x00,0x02,0x00,0x3a,0x00,0x00,0x00};
static uint8_t RECV_ATT_EXT_MTU[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x02,XXXX,XXXX};
static uint8_t RSP_ATT_EXT_MTU[] = {0x02,0x40,0x00,0x07,0x00,0x03,0x00,0x04,0x00,0x03,0x17,0x00};
static uint8_t SEND_CONN_PARAM_UPDATE_REQ[] = {0x02,0x40,0x00,0x10,0x00,0x0C,0x00,0x05,0x00,0x12,0x00,0x08,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x01};
static uint8_t RECV_L2CAP_PARAM_UPDATE_REQ[] = {0x02,XXXX,XXXX,0x10,0x00,0x0c,0x00,0x05,0x00,0x12,0x5f,0x08,0x00,0x06,0x00,0x06,0x00,0x04,0x00, 0x00, 0x01};
static uint8_t RSP_L2CAP_PARAM_UPDATE[] = {0x02,0x40,0x00,0x0a,0x00,0x06,0x00,0x05,0x00,0x13,0x02,0x02,0x00,0x00,0x00};
static uint8_t SEND_SMP_SECURITY_REQ[] = {0x02,0x40,0x00,0x06,0x00,0x02,0x00,0x06,0x00,0x0B,0x01};
static uint8_t SEND_SMP_PAIRING_REQ[] = {0x02,0x40,0x00,0x0B,0x00,0x07,0x00,0x06,0x00,0x01,0x03,0x00,0x01,0x10,0x03,0x03};
static uint8_t RECV_SMP_PAIRING_REQ[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x06,0x00,0x01};
static uint8_t RSP_SMP_PAIRING[] = {0x02,0x40,0x20,0x0b,0x00,0x07,0x00,0x06,0x00,0x02,0x03,0x00,0x01,0x10,0x00,0x03};
static uint8_t RECV_SMP_PAIRING_CFM[] = {0x02,XXXX,XXXX,0x15,0x00,0x11,0x00,0x06,0x00,0x03};
static uint8_t RSP_SMP_PAIRING_CFM[] = {0x02,0x40,0x20,0x15,0x00,0x11,0x00,0x06,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static uint8_t RECV_SMP_PAIRING_RND[] = {0x02,XXXX,XXXX,0x15,0x00,0x11,0x00,0x06,0x00,0x04};
static uint8_t RSP_SMP_PAIRING_RND[] = {0x02,0x40,0x20,0x15,0x00,0x11,0x00,0x06,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static uint8_t RECV_STK_REQ[] = {0x04,0x3e,0x0d,0x05,XXXX,XXXX,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static uint8_t RSP_RECV_LTK[] = {0x01,0x1a,0x20,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static uint8_t RSP_RECV_LTK_NEG[] = {0x01,0x1b,0x20,0x02,0x00,0x00};
static uint8_t RECV_ENC_CHANGE[] = {0x04,0x08,0x04,0x00,XXXX,XXXX,0x01};
static uint8_t SEND_ENC_INFO[] = {0x02,XXXX,XXXX,0x15,0x00,0x11,0x00,0x06,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static uint8_t RECV_ENC_INFO[] = {0x02,XXXX,XXXX,0x15,0x00,0x11,0x00,0x06,0x00,0x06};
static uint8_t SEND_MASTER_ID[] = {0x02,XXXX,XXXX,0x0f,0x00,0x0b,0x00,0x06,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
static uint8_t SEND_IDENTITY_ADDR_INFO[] = {0x02,XXXX,XXXX,0x0c,0x00,0x08,0x00,0x06,0x00,0x09,0x01, LOCAL_RAND_ADDR};
#define LOCAL_IRK 0x01,0x02,0x11,0x04,0x81,0xf1,0x11,0x03,0xde,0x66,0x33,0x24,0xd2,0x19,0x48,0x0c, // whatever
static uint8_t SEND_IDENTITY_INFO[] = {0x02,XXXX,XXXX,0x15,0x00,0x11,0x00,0x06,0x00,0x08,LOCAL_IRK};



static uint8_t RECV_MASTER_ID[] = {0x02,XXXX,XXXX,0x0f,0x00,0x0b,0x00,0x06,0x00,0x07};
static uint8_t SEND_ID_INFO[] = {0x02,XXXX,XXXX,0x15,0x00,0x11,0x00,0x06,0x00,0x08,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,};
static uint8_t RECV_ID_INFO[] = {0x02,XXXX,XXXX,0x0f,0x00,0x0b,0x00,0x06,0x00,0x07,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,};
static uint8_t SEND_ID_ADDR_INFO[] = {0x02,XXXX,XXXX,0x0c,0x00,0x08,0x00,0x06,0x00,0x09,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,};
static uint8_t RECV_ID_ADDR_INFO[] = {0x02,XXXX,XXXX,0x0c,0x00,0x08,0x00,0x06,0x00,0x09,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,};
static uint8_t CMD_START_ENCRYPT[] = {0x01,0x19,0x20,0x1c,XXXX,XXXX,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,};

static uint8_t RECV_GATT_GET_ATT_DEV_NAME[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,XXXX,XXXX,XXXX,XXXX,0x00,0x2a};
static uint8_t RSP_GATT_GET_ATT_DEV_NAME[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x08,0x06,0x00,0x0a};
static uint8_t RECV_GATT_FIND_PnP_ID[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,XXXX,XXXX,XXXX,XXXX,0x50,0x2a};
static uint8_t RSP_GATT_FIND_PnP_ID[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x08,0x01,0x00,0x0a};
static uint8_t RECV_GATT_READ_ALL_GROUP_TYPE[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x10,0x01,0x00,0xff,0xff,0x00,0x28};
//# 1 - service
//# 2~3 - report map
//# 4~7 - report
//# 8~b - report
//# 0c~0d - info
//#	 ''' Report map:
//#	 05010906a101050719e029e715002501750195088102
//#	 95017508810195067508150025650507190029658100
//#	 0905150026ff0075089502b102c0
//#	 05010902a10185010901a10005091901290815002501
//#	 75019508810205011608ff26ff007510950209300931
//#	 81061581257f7508950109388106c0c0
//#	 '''
static uint8_t RSP_GATT_READ_ALL_GROUP_TYPE[] = {0x02,XXXX,XXXX,0x0c,0x00,0x08,0x00,0x04,0x00,0x11,0x06,0x01,0x00,0x0d,0x00,0x12,0x18};
static uint8_t RECV_GATT_READ_GROUP_TYPE_AGAIN[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x10,XXXX,XXXX,0xff,0xff,0x00,0x28};
static uint8_t RSP_GATT_READ_GROUP_TYPE_AGAIN[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x10,0x10,0x00,0x0a}; //not found
static uint8_t RECV_GATT_READ_INCLUDE[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x01,0x00,XXXX,XXXX,0x02,0x28};
static uint8_t RSP_GATT_READ_INCLUDE[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x08,0x01,0x00,0x0a}; // not found
static uint8_t RECV_GATT_READ_SEC_SERV[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x10,XXXX,XXXX,XXXX,XXXX,0x01,0x28};
static uint8_t RSP_GATT_READ_SEC_SERV[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x10,0x01,0x00,0x0a}; //not found
static uint8_t RECV_GATT_FIND_CHAR_1[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x01,0x00,XXXX,0x00,0x03,0x28};
static uint8_t RSP_GATT_FIND_CHAR_1[] = {0x02,XXXX,XXXX,0x1b,0x00,0x17,0x00,0x04,0x00,0x09,0x07,0x02,0x00,0x02,0x03,0x00,0x4b,0x2a,0x04,0x00,0x12,0x05,0x00,0x4d,0x2a,0x08,0x00,0x12,0x09,0x00,0x4d,0x2a};
static uint8_t RECV_GATT_FIND_CHAR_21[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x09,0x00,XXXX,0x00,0x03,0x28};
static uint8_t RECV_GATT_FIND_CHAR_22[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x0a,0x00,XXXX,0x00,0x03,0x28};
static uint8_t RSP_GATT_FIND_CHAR_2[] = {0x02,XXXX,XXXX,0x0d,0x00,0x09,0x00,0x04,0x00,0x09,0x07,0x0c,0x00,0x02,0x0d,0x00,0x4a,0x2a};
static uint8_t RECV_GATT_FIND_CHAR_31[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x0d,0x00,XXXX,0x00,0x03,0x28};
static uint8_t RECV_GATT_FIND_CHAR_32[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x0e,0x00,XXXX,0x00,0x03,0x28};
static uint8_t RSP_GATT_FIND_CHAR_3[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x08,0x0e,0x00,0x0a}; //not found
static uint8_t RECV_GATT_FIND_CHAR_4[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x0f,0x00,XXXX,0x00,0x03,0x28}; //adapt android
static uint8_t RSP_GATT_FIND_CHAR_4[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x08,0x0e,0x00,0x0a};
static uint8_t RECV_GATT_FIND_INFO_1[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x04,0x06,0x00,0x07,0x00};
static uint8_t RSP_GATT_FIND_INFO_1[] = {0x02,XXXX,XXXX,0x0e,0x00,0x0a,0x00,0x04,0x00,0x05,0x01,0x06,0x00,0x02,0x29,0x07,0x00,0x08,0x29};
static uint8_t RECV_GATT_FIND_INFO_2[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x04,0x0a,0x00,0x0b,0x00};
static uint8_t RSP_GATT_FIND_INFO_2[] = {0x02,XXXX,XXXX,0x0e,0x00,0x0a,0x00,0x04,0x00,0x05,0x01,0x0a,0x00,0x02,0x29,0x0b,0x00,0x08,0x29};
static uint8_t RECV_GATT_READ_REPORT1[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x05,0x00};
static uint8_t RSP_GATT_READ_REPORT1[] = {0x02,XXXX,XXXX,0x05,0x00,0x01,0x00,0x04,0x00,0x0b};
static uint8_t RECV_GATT_READ_REPORT2[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x09,0x00};
static uint8_t RSP_GATT_READ_REPORT2[] = {0x02,XXXX,XXXX,0x05,0x00,0x01,0x00,0x04,0x00,0x0b};
static uint8_t RECV_GATT_READ_REPORT_MAP[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x03,0x00};
static uint8_t RSP_GATT_READ_REPORT_MAP[] = {0x02,XXXX,XXXX,0x1b,0x00,0x17,0x00,0x04,0x00,0x0b,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX};
static uint8_t RECV_GATT_READ_REPORT_MAP_CTN[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x0c,0x03,0x00,XXXX,0x00};
static uint8_t RSP_GATT_READ_REPORT_DATA[] = {0x05,0x01,0x09,0x06,0xa1,0x01,0x85,0x01,0x05,0x07,0x19,0xe0,0x29,0xe7,0x15,0x00,0x25,0x01,0x75,0x01,0x95,0x08,0x81,0x02,
								 0x95,0x01,0x75,0x08,0x81,0x01,0x95,0x06,0x75,0x08,0x15,0x00,0x25,0x65,0x05,0x07,0x19,0x00,0x29,0x65,0x81,0x00,
								 0x09,0x05,0x15,0x00,0x26,0xff,0x00,0x75,0x08,0x95,0x02,0xb1,0x02,0xc0,
								 0x05,0x01,0x09,0x02,0xa1,0x01,0x85,0x02,0x09,0x01,0xa1,0x00,0x05,0x09,0x19,0x01,0x29,0x08,0x15,0x00,0x25,0x01,
								 0x75,0x01,0x95,0x08,0x81,0x02,0x05,0x01,0x16,0x08,0xff,0x26,0xff,0x00,0x75,0x10,0x95,0x02,0x09,0x30,0x09,0x31,
								 0x81,0x06,0x15,0x81,0x25,0x7f,0x75,0x08,0x95,0x01,0x09,0x38,0x81,0x06,0xc0,0xc0};
static uint8_t RSP_GATT_READ_REPORT_MAP_CTN[] = {0x02,XXXX,XXXX,0x1b,0x00,0x17,0x00,0x04,0x00,0x0d,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX};
static uint8_t RECV_GATT_READ_REPORT_REF1[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x07,0x00};
static uint8_t RSP_GATT_READ_REPORT_REF1[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0b,0x01,0x01};
static uint8_t RECV_GATT_READ_REPORT_REF2[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x0b,0x00};
static uint8_t RSP_GATT_READ_REPORT_REF2[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0b,0x02,0x01};
static uint8_t RECV_GATT_READ_REPORT_INFO[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x0d,0x00};
static uint8_t RSP_GATT_READ_REPORT_INFO[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x0b,0x00,0x00,0x00,0x02};
static uint8_t RECV_GATT_WRITE_DES11[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x12,0x06,0x00,0x01,0x00};
static uint8_t RECV_GATT_WRITE_DES12[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x12,0x0a,0x00,0x01,0x00};
static uint8_t RSP_GATT_WRITE_DES1_INSUFF[] = {0x02,0x08,0x20,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x12,0x08,0x00,0x05};
static uint8_t RSP_GATT_WRITE_DES1[] = {0x02,XXXX,XXXX,0x05,0x00,0x01,0x00,0x04,0x00,0x13};
static uint8_t RECV_GATT_READ_DES1[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x06,0x00};
static uint8_t RECV_GATT_READ_DES2[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x0a,0x00};
static uint8_t RSP_GATT_READ_DES[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0b,0x01,0x00};
static uint8_t RECV_NUM_CMP[] = {0x04,0x13,0x05,0x01,XXXX,XXXX,XXXX,XXXX};

static uint8_t RECV_RECONNECT_LTK_REQ[] = {0x04,0x3e,0x0d,0x05,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,};
static uint8_t RSP_RECONNECT_LTK[] = {0x01,0x1a,0x20,0x12,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,};

static uint8_t RECV_GATT_GET_GAP_SVC[] = {0x02,XXXX,XXXX,0x0D,0x00,0x09,0x00,0x04,0x00,0x06,0x01,0x00,0xFF,0xFF,0x00,0x28,0x00,0x18};
static uint8_t RSP_GATT_GET_GAP_SVC[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x07,0x10,0x00,0x14,0x00};
//static uint8_t RSP_GATT_GET_GAP_SVC[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x06,0x20,0x00,0x0a};
static uint8_t RECV_GATT_GET_GAP_CHAR[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x10,0x00,0x14,0x00,0x03,0x28};
static uint8_t RSP_GATT_GET_GAP_CHAR[] = {0x02,XXXX,XXXX,0x14,0x00,0x10,0x00,0x04,0x00,0x09,0x07,0x11,0x00,0x02,0x12,0x00,0x00,0x2a,0x13,0x00,0x02,0x14,0x00,0x01,0x2a};
static uint8_t RECV_GATT_GET_NAME[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x12,0x00};
static uint8_t RSP_GATT_GET_NAME[] = {0x02,XXXX,XXXX,0x06,0x00,0x02,0x00,0x04,0x00,0x0b,0x5f};
static uint8_t RECV_GATT_GET_APPE[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x14,0x00};
static uint8_t RSP_GATT_GET_APPE[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0b,0xc1,0x03};

static uint8_t RECV_GATT_GET_GATT_SVC[] = {0x02,XXXX,XXXX,0x0D,0x00,0x09,0x00,0x04,0x00,0x06,0x01,0x00,0xFF,0xFF,0x00,0x28,0x01,0x18};
static uint8_t RSP_GATT_GET_GATT_SVC[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x07,0x20,0x00,0x23,0x00};
//static uint8_t RSP_GATT_GET_GATT_SVC[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x06,0x10,0x00,0x0a};
static uint8_t RECV_GATT_GET_GATT_CHAR[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x20,0x00,0x23,0x00,0x03,0x28};
static uint8_t RSP_GATT_GET_GATT_CHAR[] = {0x02,XXXX,XXXX,0x0d,0x00,0x09,0x00,0x04,0x00,0x09,0x07,0x21,0x00,0x20,0x22,0x00,0x05,0x2a};
static uint8_t RECV_GATT_GET_GATT_INFO[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x04,0x23,0x00,0x23,0x00};
static uint8_t RSP_GATT_GET_GATT_INFO[] = {0x02,XXXX,XXXX,0x0a,0x00,0x06,0x00,0x04,0x00,0x05,0x01,0x23,0x00,0x02,0x29};
static uint8_t RECV_GATT_WRITE_GATT_DES[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x12,0x23,0x00,XXXX,XXXX};
static uint8_t RSP_GATT_WRITE_GATT_DES[] = {0x02,XXXX,XXXX,0x05,0x00,0x01,0x00,0x04,0x00,0x13};

static uint8_t RECV_GATT_GET_SCAN_SVC[] = {0x02,XXXX,XXXX,0x0D,0x00,0x09,0x00,0x04,0x00,0x06,0x01,0x00,0xFF,0xFF,0x00,0x28,0x13,0x18};
static uint8_t RSP_GATT_GET_SCAN_SVC[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x06,0x01,0x00,0x0a};

static uint8_t RECV_GATT_GET_BATT[] = {0x02,XXXX,XXXX,0x0D,0x00,0x09,0x00,0x04,0x00,0x06,0x01,0x00,0xff,0xff,0x00,0x28,0x0f,0x18};
static uint8_t RSP_GATT_GET_BATT[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x07,0x30,0x00,0x32,0x00};
static uint8_t RECV_GATT_GET_BATT_CHAR[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x30,0x00,0x32,0x00,0x03,0x28};
static uint8_t RSP_GATT_GET_BATT_CHAR[] = {0x02,XXXX,XXXX,0x0d,0x00,0x09,0x00,0x04,0x00,0x09,0x07,0x31,0x00,0x02,0x32,0x00,0x19,0x2a};
static uint8_t RECV_GATT_GET_BATT_LEVEL[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x32,0x00};
static uint8_t RSP_GATT_GET_BATT_LEVEL[] = {0x02,XXXX,XXXX,0x06,0x00,0x02,0x00,0x04,0x00,0x0b,0x64};

static uint8_t RECV_GATT_GET_DEVI_SVC[] = {0x02,XXXX,XXXX,0x0D,0x00,0x09,0x00,0x04,0x00,0x06,0x01,0x00,0xFF,0xFF,0x00,0x28,0x0a,0x18};
static uint8_t RSP_GATT_GET_DEVI_SVC[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x07,0x40,0x00,0x44,0x00};
static uint8_t RECV_GATT_GET_DEVI_CHAR[] = {0x02,XXXX,XXXX,0x0b,0x00,0x07,0x00,0x04,0x00,0x08,0x40,0x00,0x44,0x00,0x03,0x28};
static uint8_t RSP_GATT_GET_DEVI_CHAR[] = {0x02,XXXX,XXXX,0x14,0x00,0x10,0x00,0x04,0x00,0x09,0x07,0x41,0x00,0x02,0x42,0x00,0x29,0x2a,0x43,0x00,0x02,0x44,0x00,0x50,0x2a};
static uint8_t RECV_GATT_GET_MNS[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x42,0x00};
static uint8_t RSP_GATT_GET_MNS[] = {0x02,XXXX,XXXX,0x06,0x00,0x02,0x00,0x04,0x00,0x0b,0x5F};
static uint8_t RECV_GATT_GET_PPID[] = {0x02,XXXX,XXXX,0x07,0x00,0x03,0x00,0x04,0x00,0x0a,0x44,0x00};
static uint8_t RSP_GATT_GET_PPID[] = {0x02,XXXX,XXXX,0x0c,0x00,0x08,0x00,0x04,0x00,0x0b,0x02,0x6d,0x04,0x4d,0xb3,0x14,0x00};

static uint8_t RECV_GATT_FIND_SVC_BY_TYPE[] = {0x02,XXXX,XXXX,0x0d,0x00,0x09,0x00,0x04,0x00,0x06,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX};
static uint8_t RSP_GATT_FIND_SVC_BY_TYPE_ERR[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x06,0x10,0x00,0x0a};
static uint8_t RECV_GATT_OTHERS_REQ[] = {0x02,XXXX,XXXX,XXXX,XXXX,XXXX,XXXX,0x04,0x00,XXXX};
static uint8_t RSP_GATT_OTHERS_ERR_RSP[] = {0x02,XXXX,XXXX,0x09,0x00,0x05,0x00,0x04,0x00,0x01,0x06,0x10,0x00,0x0a};

void send_hid(uint8_t *buf, uint8_t len)
{
	int res;
	if(buf) res = hci_send(buf, len);
	if(res < 0){ hci_reinit(send_reset); }
	return;
	if(buf){
		if(_fr == (uint8_t)(_ra+1)) return;
		memcpy(&send_buf[_ra][4], buf, len);
		send_buf[_ra][0] = len;
		_ra++;
	}
	if(acl_count > 0 && _fr != _ra){
		hci_send(&send_buf[_fr][4], send_buf[_fr][0]);
		_fr = (uint8_t)(_fr+1); acl_count--;
		send_hid(NULL, 0);
	}
}

void bt_recv_cb(uint8_t *d, int len)
{
	static int direct_adv_cnt;
	if(0){}
	IF(CMP_CMP_RESET){
		if(iat == 0x0 || (iat == 0x1 && (ia[5] & 0xC0) == 0xC0)){
			LE_SET_ADV_PARAM[8] = 0x01; // Conectable high duty cycle directed advertising
			LE_SET_ADV_PARAM[10] = iat;
			memcpy(&LE_SET_ADV_PARAM[11], ia, 6);
		}
		SEND(LE_SET_ADV_PARAM);
	}
	IF(CMP_LE_SET_ADV_PARAM){ SEND(LE_SET_RAND_ADDR);}
	IF(CMP_LE_SET_RAND_ADDR){ SEND(LE_SET_ADV_DATA);}
	IF(CMP_LE_SET_ADV_DATA){ SEND(LE_SET_ADV_ENABLE);}
	IF(RECV_LE_CONNECTED_TOUT){
		if(direct_adv_cnt++ < 8){
			SEND(LE_SET_ADV_ENABLE);
		}else{
			direct_adv_cnt = 0;
			LE_SET_ADV_PARAM[8] = 0x00; // Disable conectable high duty cycle directed advertising
			SEND(LE_SET_ADV_PARAM);
		}
	}
	IF(RECV_LE_DISCONNECTED){ hid_enabled = 0; puts("Device disconnected !");SEND(CMD_RESET);}
	IF(RECV_IOS_UNKNOWN_L2CAP){ SET_HANDLE(RSP_IOS_UNKNOWN_L2CAP, 1); SEND(RSP_IOS_UNKNOWN_L2CAP);}
	IF(RECV_LE_CONNECTED){
		puts("Device connected !");
		is_reconnect = false;
		//SEND(SEND_SMP_SECURITY_REQ);
		report_data_offset = 0;
		conn_handle = *(uint16_t*)&d[5];
		iat = d[8]; memcpy(ia, &d[9], 6);
		SET_HANDLE(RECV_L2CAP_PARAM_UPDATE_REQ, 1);
		SEND(RECV_L2CAP_PARAM_UPDATE_REQ);
	}IF(RECV_ATT_EXT_MTU){ SET_HANDLE(RSP_ATT_EXT_MTU, 1); SEND(RSP_ATT_EXT_MTU);}
	IF(RECV_SMP_PAIRING_REQ){
		//return; // For debug
		memcpy(smp_req, &d[9], 7);
		memcpy(smp_rsp, &RSP_SMP_PAIRING[9], 7);
		SET_HANDLE(RSP_SMP_PAIRING, 1);
		SEND(RSP_SMP_PAIRING);
	}IF(RECV_SMP_PAIRING_CFM){
		RAND(rrand, 16);
		btc_confirm_value(tk, rrand, smp_req, smp_rsp, iat, ia, rat, ra, &RSP_SMP_PAIRING_CFM[10]);
		#if 0
			printf("rrand ->  "); DUMP(rrand, 16);
			printf("smp_req ->  "); DUMP(smp_req, 7);
			printf("smp_rsp ->  "); DUMP(smp_rsp, 7);
			printf("ia ->  "); DUMP(ia, 6);
			printf("ra ->  "); DUMP(ra, 6);
			printf("iat:%d rat:%d\n", iat, rat);
		#endif
		SET_HANDLE(RSP_SMP_PAIRING_CFM, 1);
		SEND(RSP_SMP_PAIRING_CFM);
	}IF(RECV_SMP_PAIRING_RND){
		SET_HANDLE(RSP_SMP_PAIRING_RND, 1);
		memcpy(irand, &d[10], 16);
		memcpy(&RSP_SMP_PAIRING_RND[10], rrand, 16);
		SEND(RSP_SMP_PAIRING_RND);
	}IF(RECV_STK_REQ){
		SET_HANDLE(RSP_RECV_LTK, 4);
		btc_s1(tk, rrand, irand, &RSP_RECV_LTK[6]);
		SEND(RSP_RECV_LTK);
	}IF(RECV_ENC_CHANGE){
		encrypted = true;
		if(!is_reconnect){
			RAND(&SEND_MASTER_ID[10], 10);
			memcpy(&SEND_ENC_INFO[10], &SEND_MASTER_ID[10], 10); // TODO: Encode
			memcpy(&SEND_ENC_INFO[10+10], &SEND_MASTER_ID[10], 6);
			btc_e(local_ltk, &SEND_ENC_INFO[10]);

			SET_HANDLE(SEND_ENC_INFO, 1);
			SEND(SEND_ENC_INFO);
			SET_HANDLE(SEND_MASTER_ID, 1);
			SEND(SEND_MASTER_ID);
			SET_HANDLE(SEND_IDENTITY_INFO, 1);
			SEND(SEND_IDENTITY_INFO);
			SET_HANDLE(SEND_IDENTITY_ADDR_INFO, 1);
			SEND(SEND_IDENTITY_ADDR_INFO);
		}else{
			hid_enabled += 2;
		}
	}IF(RECV_RECONNECT_LTK_REQ){
		is_reconnect = true;
		memcpy(&SEND_MASTER_ID[10+2], &d[6+0], 8); // rand
		memcpy(&SEND_MASTER_ID[10+0], &d[6+8], 2); // ediv

		SET_HANDLE(RSP_RECV_LTK, 4);
		memcpy(&RSP_RECV_LTK[6], &SEND_MASTER_ID[10], 10); // TODO: Decode
		memcpy(&RSP_RECV_LTK[6+10], &SEND_MASTER_ID[10], 6);
		btc_e(local_ltk, &RSP_RECV_LTK[6]);

		SEND(RSP_RECV_LTK);
	}IF(RECV_NUM_CMP){
		acl_count += *(uint16_t*)&d[6];
		send_hid(NULL, 0);

	// Type Search Service & Characteristic
	}IF(RECV_GATT_GET_GATT_SVC){
		SET_HANDLE(RSP_GATT_GET_GATT_SVC, 1);
		SEND(RSP_GATT_GET_GATT_SVC);
	}IF(RECV_GATT_GET_GAP_SVC){
		SET_HANDLE(RSP_GATT_GET_GAP_SVC, 1);
		SEND(RSP_GATT_GET_GAP_SVC);
	}IF(RECV_GATT_GET_SCAN_SVC){
		SET_HANDLE(RSP_GATT_GET_SCAN_SVC, 1);
		SEND(RSP_GATT_GET_SCAN_SVC);
	}IF(RECV_GATT_GET_DEVI_SVC){
		SET_HANDLE(RSP_GATT_GET_DEVI_SVC, 1);
		SEND(RSP_GATT_GET_DEVI_SVC);
	}IF(RECV_GATT_GET_DEVI_CHAR){
		SET_HANDLE(RSP_GATT_GET_DEVI_CHAR, 1);
		SEND(RSP_GATT_GET_DEVI_CHAR);
	}IF(RECV_GATT_GET_MNS){
		SET_HANDLE(RSP_GATT_GET_MNS, 1);
		SEND(RSP_GATT_GET_MNS);
	}IF(RECV_GATT_GET_PPID){
		SET_HANDLE(RSP_GATT_GET_PPID, 1);
		SEND(RSP_GATT_GET_PPID);

	}IF(RECV_GATT_GET_BATT){
		SET_HANDLE(RSP_GATT_GET_BATT, 1);
		SEND(RSP_GATT_GET_BATT);
	}IF(RECV_GATT_GET_BATT_CHAR){
		SET_HANDLE(RSP_GATT_GET_BATT_CHAR, 1);
		SEND(RSP_GATT_GET_BATT_CHAR);
	}IF(RECV_GATT_GET_BATT_LEVEL){
		SET_HANDLE(RSP_GATT_GET_BATT_LEVEL, 1);
		SEND(RSP_GATT_GET_BATT_LEVEL);
	}IF(RECV_GATT_GET_GAP_CHAR){
		SET_HANDLE(RSP_GATT_GET_GAP_CHAR, 1);
		SEND(RSP_GATT_GET_GAP_CHAR);
	}IF(RECV_GATT_GET_NAME){
		SET_HANDLE(RSP_GATT_GET_NAME, 1);
		SEND(RSP_GATT_GET_NAME);
	}IF(RECV_GATT_GET_APPE){
		SET_HANDLE(RSP_GATT_GET_APPE, 1);
		SEND(RSP_GATT_GET_APPE);
	}IF(RECV_GATT_GET_GATT_CHAR){
		SET_HANDLE(RSP_GATT_GET_GATT_CHAR, 1);
		SEND(RSP_GATT_GET_GATT_CHAR);
	}IF(RECV_GATT_GET_GATT_INFO){
		SET_HANDLE(RSP_GATT_GET_GATT_INFO, 1);
		SEND(RSP_GATT_GET_GATT_INFO);
	}IF(RECV_GATT_WRITE_GATT_DES){
		SET_HANDLE(RSP_GATT_WRITE_GATT_DES, 1);
		SEND(RSP_GATT_WRITE_GATT_DES);



	}IF(RECV_GATT_READ_REPORT1){
		SET_HANDLE(RSP_GATT_READ_REPORT1, 1);
		SEND(RSP_GATT_READ_REPORT1);
	}IF(RECV_GATT_READ_REPORT2){
		SET_HANDLE(RSP_GATT_READ_REPORT2, 1);
		SEND(RSP_GATT_READ_REPORT2);

	}IF(RECV_GATT_GET_ATT_DEV_NAME){
		SET_HANDLE(RSP_GATT_GET_ATT_DEV_NAME, 1);
		SEND(RSP_GATT_GET_ATT_DEV_NAME);
	}IF(RECV_GATT_FIND_PnP_ID){
		SET_HANDLE(RSP_GATT_FIND_PnP_ID, 1);
		SEND(RSP_GATT_FIND_PnP_ID);
	}IF(RECV_GATT_READ_ALL_GROUP_TYPE){
		SET_HANDLE(RSP_GATT_READ_ALL_GROUP_TYPE, 1);
		SEND(RSP_GATT_READ_ALL_GROUP_TYPE);
	}IF(RECV_GATT_READ_GROUP_TYPE_AGAIN){
		SET_HANDLE(RSP_GATT_READ_GROUP_TYPE_AGAIN, 1);
		SEND(RSP_GATT_READ_GROUP_TYPE_AGAIN);
	}IF(RECV_GATT_READ_INCLUDE){
		SET_HANDLE(RSP_GATT_READ_INCLUDE, 1);
		SEND(RSP_GATT_READ_INCLUDE);
	}IF(RECV_GATT_READ_SEC_SERV){
		SET_HANDLE(RSP_GATT_READ_SEC_SERV, 1);
		SEND(RSP_GATT_READ_SEC_SERV);
	}IF(RECV_GATT_FIND_CHAR_1){
		SET_HANDLE(RSP_GATT_FIND_CHAR_1, 1);
		SEND(RSP_GATT_FIND_CHAR_1);
	}IFOR(RECV_GATT_FIND_CHAR_21, RECV_GATT_FIND_CHAR_22){
		SET_HANDLE(RSP_GATT_FIND_CHAR_2, 1);
		SEND(RSP_GATT_FIND_CHAR_2);
	}IFOR(RECV_GATT_FIND_CHAR_31, RECV_GATT_FIND_CHAR_32){
		SET_HANDLE(RSP_GATT_FIND_CHAR_3, 1);
		SEND(RSP_GATT_FIND_CHAR_3);
	}IF(RECV_GATT_FIND_CHAR_4){
		SET_HANDLE(RSP_GATT_FIND_CHAR_4, 1);
		SEND(RSP_GATT_FIND_CHAR_4);
	}IF(RECV_GATT_FIND_INFO_1){
		SET_HANDLE(RSP_GATT_FIND_INFO_1, 1);
		SEND(RSP_GATT_FIND_INFO_1);
	}IF(RECV_GATT_FIND_INFO_2){
		SET_HANDLE(RSP_GATT_FIND_INFO_2, 1);
		SEND(RSP_GATT_FIND_INFO_2);
	}IF(RECV_GATT_READ_DES1){
		SET_HANDLE(RSP_GATT_READ_DES, 1);
		SEND(RSP_GATT_READ_DES);
		hid_enabled++;
	}IF(RECV_GATT_READ_DES2){
		SET_HANDLE(RSP_GATT_READ_DES, 1);
		SEND(RSP_GATT_READ_DES);
		hid_enabled++;
	}IF(RECV_GATT_READ_REPORT_MAP){
		SET_HANDLE(RSP_GATT_READ_REPORT_MAP, 1);
		memcpy(&RSP_GATT_READ_REPORT_MAP[10], RSP_GATT_READ_REPORT_DATA, 22);
		SEND(RSP_GATT_READ_REPORT_MAP);
		report_data_offset += 22;

	}IF(RECV_GATT_READ_REPORT_MAP_CTN){
		int remain = sizeof(RSP_GATT_READ_REPORT_DATA) - report_data_offset;
		if(remain >= 22){
			SET_HANDLE(RSP_GATT_READ_REPORT_MAP_CTN, 1);
			memcpy(&RSP_GATT_READ_REPORT_MAP_CTN[10], &RSP_GATT_READ_REPORT_DATA[report_data_offset], 22);
			SEND(RSP_GATT_READ_REPORT_MAP_CTN);
			report_data_offset += 22;
		}else{
			uint8_t RSP_GATT_READ_REPORT_MAP_CTN_LAST[10+remain];
			memcpy(RSP_GATT_READ_REPORT_MAP_CTN_LAST, RSP_GATT_READ_REPORT_MAP_CTN, 10+remain);
			SET_HANDLE(RSP_GATT_READ_REPORT_MAP_CTN_LAST, 1);
			*(uint16_t*)&RSP_GATT_READ_REPORT_MAP_CTN_LAST[3] = remain + 5;
			*(uint16_t*)&RSP_GATT_READ_REPORT_MAP_CTN_LAST[5] = remain + 1;
			memcpy(&RSP_GATT_READ_REPORT_MAP_CTN_LAST[10], &RSP_GATT_READ_REPORT_DATA[report_data_offset], remain);
			SEND(RSP_GATT_READ_REPORT_MAP_CTN_LAST);
			report_data_offset = 0;
		}
	}IF(RECV_GATT_READ_REPORT_REF1){
		SET_HANDLE(RSP_GATT_READ_REPORT_REF1, 1);
		SEND(RSP_GATT_READ_REPORT_REF1);
	}IF(RECV_GATT_READ_REPORT_REF2){
		SET_HANDLE(RSP_GATT_READ_REPORT_REF2, 1);
		SEND(RSP_GATT_READ_REPORT_REF2);
	}IF(RECV_GATT_READ_REPORT_INFO){
		SET_HANDLE(RSP_GATT_READ_REPORT_INFO, 1);
		SEND(RSP_GATT_READ_REPORT_INFO);
	}IFOR(RECV_GATT_WRITE_DES11, RECV_GATT_WRITE_DES12){
		if(encrypted){
			SET_HANDLE(RSP_GATT_WRITE_DES1, 1);
			SEND(RSP_GATT_WRITE_DES1);
			hid_enabled++;
		}else{
			SET_HANDLE(RSP_GATT_WRITE_DES1_INSUFF, 1);
			SEND(RSP_GATT_WRITE_DES1_INSUFF);
		}
	}
	IF(RECV_GATT_OTHERS_REQ){
		SET_HANDLE(RSP_GATT_OTHERS_ERR_RSP, 1);
		memcpy(&RSP_GATT_OTHERS_ERR_RSP[10], &d[9], 3);
		SEND(RSP_GATT_OTHERS_ERR_RSP);
	}
}
void send_reset(void){ SEND(CMD_RESET); }
bool HID_ENABLED(void){ return hid_enabled>1; }
void SET_HANDLE(uint8_t *data, int offset){ *(uint16_t*)&data[offset] = conn_handle; }
#if 0
int main(int argc, char *argv[])
{
	usb_dev_handle *h = hci_init(USB_LOG_OUTPUT, bt_recv_cb);
	SEND(CMD_RESET);
	while(1){ Sleep(2000); }
}
#endif
